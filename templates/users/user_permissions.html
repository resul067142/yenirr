{% extends 'layout/base.html' %}

{% block title %}Yetki ve Rol Yönetimi - Cihaz Takip Sistemi{% endblock %}

{% block content %}
<div class="permissions-container">
    <!-- Compact Header -->
    <div class="compact-header">
        <div class="header-actions">
            <a href="{% url 'users:user_list' %}" class="btn btn-secondary">
                <i class="fas fa-users"></i>
                Kullanıcı Listesi
            </a>
            <a href="{% url 'users:add_user' %}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                Yeni Kullanıcı
            </a>
            <a href="{% url 'dashboard:home' %}" class="btn btn-secondary">
                <i class="fas fa-home"></i>
                Ana Sayfa
            </a>
        </div>
    </div>

    <!-- Hover Panels Section -->
    <div class="hover-panels-section">
        <!-- User Statistics Panel -->
        <div class="hover-panel user-stats-panel">
            <div class="panel-trigger">
                <i class="fas fa-chart-pie"></i>
                <span>Kullanıcı İstatistikleri</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-content">
                <div class="compact-stats-grid">
                    <div class="compact-stat">
                        <div class="compact-stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="compact-stat-number">{{ users|length }}</div>
                        <div class="compact-stat-label">Toplam Kullanıcı</div>
                    </div>
                    <div class="compact-stat">
                        <div class="compact-stat-icon info">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="compact-stat-number">{{ active_users|default:0 }}</div>
                        <div class="compact-stat-label">Aktif Kullanıcı</div>
                    </div>
                    <div class="compact-stat">
                        <div class="compact-stat-icon warning">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="compact-stat-number">{{ admin_users|default:0 }}</div>
                        <div class="compact-stat-label">Admin Kullanıcı</div>
                    </div>
                    <div class="compact-stat">
                        <div class="compact-stat-icon danger">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="compact-stat-number">{{ superadmin_users|default:0 }}</div>
                        <div class="compact-stat-label">Süper Admin</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Panel -->
        <div class="hover-panel quick-actions-panel">
            <div class="panel-trigger">
                <i class="fas fa-bolt"></i>
                <span>Hızlı İşlemler</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-content">
                <div class="actions-grid" style="grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <a onclick="saveAllPermissions()" class="action-card">
                        <div class="action-icon">
                            <i class="fas fa-save"></i>
                        </div>
                        <div class="action-title">Tüm Yetkileri Kaydet</div>
                        <div class="action-description">Tüm değişiklikleri kaydet</div>
                    </a>
                    <a onclick="resetAllPermissions()" class="action-card">
                        <div class="action-icon orange">
                            <i class="fas fa-undo"></i>
                        </div>
                        <div class="action-title">Sıfırla</div>
                        <div class="action-description">Değişiklikleri geri al</div>
                    </a>
                    <a onclick="bulkRoleUpdate()" class="action-card">
                        <div class="action-icon purple">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <div class="action-title">Toplu Rol Güncelle</div>
                        <div class="action-description">Çoklu kullanıcı güncelle</div>
                    </a>
                    <a onclick="exportPermissions()" class="action-card">
                        <div class="action-icon blue">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="action-title">Yetkileri Dışa Aktar</div>
                        <div class="action-description">PDF/Excel rapor oluştur</div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Toplam Kullanıcı</div>
                        <div class="stat-value">{{ users|length }}</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon green">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Aktif Kullanıcı</div>
                        <div class="stat-value">{{ active_users|default:0 }}</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon purple">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Admin Kullanıcı</div>
                        <div class="stat-value">{{ admin_users|default:0 }}</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon yellow">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Süper Admin</div>
                        <div class="stat-value">{{ superadmin_users|default:0 }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table Section -->
    <div class="users-section">
        <div class="users-header">
            <h3 class="section-title">
                <i class="fas fa-list"></i>
                Kullanıcı Listesi ve Yetki Yönetimi
            </h3>
            <div class="header-actions">
                <button onclick="saveAllPermissions()" class="btn btn-success">
                    <i class="fas fa-save"></i>
                    Tüm Yetkileri Kaydet
                </button>
                <button onclick="resetAllPermissions()" class="btn btn-warning">
                    <i class="fas fa-undo"></i>
                    Sıfırla
                </button>
                <button onclick="bulkRoleUpdate()" class="btn btn-primary">
                    <i class="fas fa-users-cog"></i>
                    Toplu Güncelle
                </button>
            </div>
        </div>

        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Kullanıcı</th>
                        <th>Rol</th>
                        <th>Durum</th>
                        <th>İletişim</th>
                        <th colspan="3">Yetki Grupları</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="user-row" data-user-id="{{ user.id }}">
                        <!-- User Info -->
                        <td class="user-info">
                            <div class="user-avatar">
                                {% if user.profile_image %}
                                    <img src="{{ user.profile_image.url }}" alt="Profil">
                                {% else %}
                                    <i class="fas fa-user"></i>
                                {% endif %}
                            </div>
                            <div class="user-details">
                                <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                                <div class="user-username">@{{ user.username }}</div>
                            </div>
                        </td>

                        <!-- Role -->
                        <td class="user-role">
                            <span class="role-badge role-{{ user.role|default:'user' }}">
                                {% if user.role == 'superadmin' %}
                                    <i class="fas fa-crown"></i> Süper Admin
                                {% elif user.role == 'admin' %}
                                    <i class="fas fa-shield-alt"></i> Admin
                                {% elif user.role == 'manager' %}
                                    <i class="fas fa-user-tie"></i> Müdür
                                {% elif user.role == 'supervisor' %}
                                    <i class="fas fa-user-graduate"></i> Süpervizör
                                {% elif user.role == 'technician' %}
                                    <i class="fas fa-tools"></i> Teknisyen
                                {% elif user.role == 'analyst' %}
                                    <i class="fas fa-chart-line"></i> Analist
                                {% else %}
                                    <i class="fas fa-user"></i> Kullanıcı
                                {% endif %}
                            </span>
                        </td>

                        <!-- Status -->
                        <td class="user-status">
                            <span class="status-badge status-{{ user.is_active|yesno:'active,inactive' }}">
                                {% if user.is_active %}
                                    <i class="fas fa-check-circle"></i> Aktif
                                {% else %}
                                    <i class="fas fa-times-circle"></i> Pasif
                                {% endif %}
                            </span>
                        </td>

                        <!-- Contact -->
                        <td class="user-contact">
                            <div class="contact-info">
                                <div class="contact-email">{{ user.email|truncatechars:15 }}</div>
                                <div class="contact-phone">{% if user.tc_kimlik %}{{ user.tc_kimlik|slice:":4" }}***{% else %}-{% endif %}</div>
                            </div>
                        </td>

                        <!-- Permission Groups -->
                        <td class="permission-groups">
                            <div class="permission-group">
                                <div class="group-title">
                                    <i class="fas fa-mobile-alt"></i>
                                    Cihaz Yetkileri
                                </div>
                                <div class="permission-checkboxes">
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_view_devices" 
                                               {% if user.can_view_devices %}checked{% endif %}>
                                        <span>Görüntüle</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_add_devices" 
                                               {% if user.can_add_devices %}checked{% endif %}>
                                        <span>Ekle</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_edit_devices" 
                                               {% if user.can_edit_devices %}checked{% endif %}>
                                        <span>Düzenle</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_delete_devices" 
                                               {% if user.can_delete_devices %}checked{% endif %}>
                                        <span>Sil</span>
                                    </label>
                                </div>
                            </div>
                        </td>

                        <td class="permission-groups">
                            <div class="permission-group">
                                <div class="group-title">
                                    <i class="fas fa-users"></i>
                                    Kullanıcı Yetkileri
                                </div>
                                <div class="permission-checkboxes">
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_view_users" 
                                               {% if user.can_view_users %}checked{% endif %}>
                                        <span>Görüntüle</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_add_users" 
                                               {% if user.can_add_users %}checked{% endif %}>
                                        <span>Ekle</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_edit_users" 
                                               {% if user.can_edit_users %}checked{% endif %}>
                                        <span>Düzenle</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_delete_users" 
                                               {% if user.can_delete_users %}checked{% endif %}>
                                        <span>Sil</span>
                                    </label>
                                </div>
                            </div>
                        </td>

                        <td class="permission-groups">
                            <div class="permission-group">
                                <div class="group-title">
                                    <i class="fas fa-chart-bar"></i>
                                    Rapor Yetkileri
                                </div>
                                <div class="permission-checkboxes">
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_view_reports" 
                                               {% if user.can_view_reports %}checked{% endif %}>
                                        <span>Görüntüle</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_export_reports" 
                                               {% if user.can_export_reports %}checked{% endif %}>
                                        <span>Dışa Aktar</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_schedule_reports" 
                                               {% if user.can_schedule_reports %}checked{% endif %}>
                                        <span>Zamanla</span>
                                    </label>
                                    <label class="permission-checkbox-item">
                                        <input type="checkbox" name="user_{{ user.id }}_can_share_reports" 
                                               {% if user.can_share_reports %}checked{% endif %}>
                                        <span>Paylaş</span>
                                    </label>
                                </div>
                            </div>
                        </td>

                        <!-- Actions -->
                        <td class="user-actions">
                            <button onclick="editUserPermissions({{ user.id }})" class="btn btn-primary btn-sm">
                                <i class="fas fa-edit"></i>
                                Düzenle
                            </button>
                            <button onclick="viewUserDetails({{ user.id }})" class="btn btn-secondary btn-sm">
                                <i class="fas fa-eye"></i>
                                Görüntüle
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Selected User Permissions (if user is selected) -->
    {% if selected_user %}
    <div class="selected-user-permissions">
        <div class="selected-user-header">
            <h3 class="section-title">
                <i class="fas fa-user-check"></i>
                Seçilen Kullanıcı: {{ selected_user.get_full_name|default:selected_user.username }}
            </h3>
            <div class="selected-user-info">
                <span class="user-badge role-{{ selected_user.role|default:'user' }}">
                    {% if selected_user.role == 'superadmin' %}
                        <i class="fas fa-crown"></i> Süper Admin
                    {% elif selected_user.role == 'admin' %}
                        <i class="fas fa-shield-alt"></i> Admin
                    {% else %}
                        <i class="fas fa-user"></i> Kullanıcı
                    {% endif %}
                </span>
                <span class="user-badge status-{{ selected_user.is_active|yesno:'active,inactive' }}">
                    {% if selected_user.is_active %}
                        <i class="fas fa-check-circle"></i> Aktif
                    {% else %}
                        <i class="fas fa-times-circle"></i> Pasif
                    {% endif %}
                </span>
            </div>
        </div>
        
        <div class="selected-user-permissions-grid">
            <!-- Device Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-mobile-alt"></i>
                    Cihaz Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_view_devices" 
                               {% if selected_user.can_view_devices %}checked{% endif %}>
                        <span>Görüntüle</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_add_devices" 
                               {% if selected_user.can_add_devices %}checked{% endif %}>
                        <span>Ekle</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_edit_devices" 
                               {% if selected_user.can_add_devices %}checked{% endif %}>
                        <span>Düzenle</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_delete_devices" 
                               {% if selected_user.can_delete_devices %}checked{% endif %}>
                        <span>Sil</span>
                    </label>
                </div>
            </div>

            <!-- User Management Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-users"></i>
                    Kullanıcı Yönetimi Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_view_users" 
                               {% if selected_user.can_view_users %}checked{% endif %}>
                        <span>Görüntüle</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_add_users" 
                               {% if selected_user.can_add_users %}checked{% endif %}>
                        <span>Ekle</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_edit_users" 
                               {% if selected_user.can_edit_users %}checked{% endif %}>
                        <span>Düzenle</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_delete_users" 
                               {% if selected_user.can_delete_users %}checked{% endif %}>
                        <span>Sil</span>
                    </label>
                </div>
            </div>

            <!-- System Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-server"></i>
                    Sistem Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_view_statistics" 
                               {% if selected_user.can_view_statistics %}checked{% endif %}>
                        <span>Sistem İstatistikleri</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_view_logs" 
                               {% if selected_user.can_view_logs %}checked{% endif %}>
                        <span>Aktivite Logları</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_export_data" 
                               {% if selected_user.can_export_data %}checked{% endif %}>
                        <span>Veri Dışa Aktarma</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_access_admin" 
                               {% if selected_user.can_access_admin %}checked{% endif %}>
                        <span>Admin Paneli</span>
                    </label>
                </div>
            </div>

            <!-- Security Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-shield-alt"></i>
                    Güvenlik Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_manage_roles" 
                               {% if selected_user.can_manage_roles %}checked{% endif %}>
                        <span>Rol Yönetimi</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_audit_logs" 
                               {% if selected_user.can_audit_logs %}checked{% endif %}>
                        <span>Denetim Logları</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_manage_permissions" 
                               {% if selected_user.can_manage_permissions %}checked{% endif %}>
                        <span>Yetki Yönetimi</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="user_{{ selected_user.id }}_can_access_api" 
                               {% if selected_user.can_access_api %}checked{% endif %}>
                        <span>API Erişimi</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="selected-user-actions">
            <button onclick="saveSelectedUserPermissions({{ selected_user.id }})" class="btn btn-success">
                <i class="fas fa-save"></i>
                Bu Kullanıcının Yetkilerini Kaydet
            </button>
            <button onclick="resetSelectedUserPermissions({{ selected_user.id }})" class="btn btn-warning">
                <i class="fas fa-undo"></i>
                Sıfırla
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Additional Permission Groups -->
    <div class="additional-permissions">
        <h3 class="section-title">
            <i class="fas fa-cogs"></i>
            Ek Yetki Grupları
        </h4>
        
        <div class="permissions-grid">
            <!-- System Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-server"></i>
                    Sistem Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="system_can_view_statistics">
                        <span>Sistem İstatistikleri</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="system_can_view_logs">
                        <span>Aktivite Logları</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="system_can_export_data">
                        <span>Veri Dışa Aktarma</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="system_can_access_admin">
                        <span>Admin Paneli</span>
                    </label>
                </div>
            </div>

            <!-- Security Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-shield-alt"></i>
                    Güvenlik Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="security_can_manage_roles">
                        <span>Rol Yönetimi</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="security_can_audit_logs">
                        <span>Denetim Logları</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="security_can_manage_permissions">
                        <span>Yetki Yönetimi</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="checkbox" name="security_can_access_api">
                        <span>API Erişimi</span>
                    </label>
                </div>
            </div>

            <!-- Data Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-database"></i>
                    Veri Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="data_can_backup">
                        <span>Backup Alma</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="data_can_restore">
                        <span>Backup Geri Yükleme</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="data_can_import">
                        <span>Veri İçe Aktarma</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="data_can_cleanup">
                        <span>Veri Temizleme</span>
                    </label>
                </div>
            </div>

            <!-- Report Permissions -->
            <div class="permission-category">
                <h4 class="category-title">
                    <i class="fas fa-chart-bar"></i>
                    Rapor Yetkileri
                </h4>
                <div class="permission-items">
                    <label class="permission-item">
                        <input type="checkbox" name="report_can_generate">
                        <span>Rapor Oluşturma</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="report_can_schedule">
                        <span>Rapor Zamanlama</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="report_can_share">
                        <span>Rapor Paylaşımı</span>
                    </label>
                    <label class="permission-item">
                        <input type="checkbox" name="report_can_archive">
                        <span>Rapor Arşivleme</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Permission Edit Modal -->
<div id="permissionModal" class="modal-overlay hidden">
    <div class="modal-container permission-modal">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-edit"></i>
                Kullanıcı Yetkilerini Düzenle
            </h3>
            <button onclick="hidePermissionModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="permissionModalContent">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal-overlay hidden">
    <div class="modal-container user-details-modal">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-user"></i>
                Kullanıcı Detayları
            </h3>
            <button onclick="hideUserDetailsModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="userDetailsContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
.permissions-container {
    max-width: 100%;
    margin: 0;
    padding: 16px;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    min-height: 100vh;
}

/* Compact Header */
.compact-header {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 16px;
}

.header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

/* Hover Panels Section */
.hover-panels-section {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.hover-panel {
    flex: 1;
    min-width: 300px;
    position: relative;
}

.panel-trigger {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    border: 1px solid #6b7280;
    border-radius: 12px;
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #e2e8f0;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.panel-trigger:hover {
    background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.panel-trigger i:first-child {
    color: #10b981;
    font-size: 18px;
}

.panel-trigger i:last-child {
    color: #9ca3af;
    transition: transform 0.3s ease;
}

.panel-content {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    border: 1px solid #6b7280;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    backdrop-filter: blur(10px);
}

.hover-panel:hover .panel-content {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.hover-panel:hover .panel-trigger i:last-child {
    transform: rotate(180deg);
}

/* Compact Stats Grid */
.compact-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
}

.compact-stat {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    border: 1px solid #4b5563;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    transition: all 0.3s ease;
}

.compact-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.compact-stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: white;
    margin: 0 auto 8px;
    background: linear-gradient(135deg, #10b981, #059669);
}

.compact-stat-icon.info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.compact-stat-icon.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.compact-stat-icon.danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.compact-stat-number {
    font-size: 18px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 4px;
}

.compact-stat-label {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 500;
}

/* Actions Grid */
.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
}

.action-card {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    border: 1px solid #4b5563;
    border-radius: 8px;
    padding: 12px;
    text-decoration: none;
    transition: all 0.3s ease;
    text-align: center;
    color: inherit;
    cursor: pointer;
}

.action-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    border-color: #10b981;
}

.action-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
    margin: 0 auto 8px;
    background: linear-gradient(135deg, #10b981, #059669);
}

.action-icon.orange {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.action-icon.purple {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.action-icon.blue {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.action-title {
    color: #e2e8f0;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
}

.action-description {
    color: #9ca3af;
    font-size: 10px;
    line-height: 1.2;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.header-content h1 {
    color: white;
    font-size: 28px;
    font-weight: 700;
    margin: 0;
}

.header-content p {
    color: rgba(255, 255, 255, 0.8);
    margin: 4px 0 0 0;
    font-size: 14px;
}

.header-actions {
    display: flex;
    gap: 12px;
}

/* Stats Section */
.stats-section {
    margin-bottom: 24px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.stat-content {
    display: flex;
    align-items: center;
    gap: 16px;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.stat-icon.blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.stat-icon.green { background: linear-gradient(135deg, #10b981, #059669); }
.stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.stat-icon.yellow { background: linear-gradient(135deg, #f59e0b, #d97706); }

.stat-info .stat-label {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 4px;
}

.stat-info .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
}

/* Users Section */
.users-section {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    margin-bottom: 24px;
    overflow: hidden;
    border: 1px solid #6b7280;
}

.users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 30px;
    border-bottom: 1px solid #e2e8f0;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-title i {
    color: #3b82f6;
}

.header-actions {
    display: flex;
    gap: 12px;
}

/* Users Table */
.users-table-container {
    overflow-x: auto;
}

.users-table {
    width: 100%;
    border-collapse: collapse;
}

.users-table th {
    background: #f8fafc;
    color: #374151;
    font-weight: 600;
    text-align: left;
    padding: 16px 20px;
    border-bottom: 2px solid #e2e8f0;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.users-table td {
    padding: 16px 20px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: top;
}

.users-table tr:hover {
    background: #f8fafc;
}

/* User Info */
.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #64748b;
    font-size: 16px;
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-details .user-name {
    font-weight: 600;
    color: #1e293b;
    font-size: 14px;
}

.user-details .user-username {
    color: #64748b;
    font-size: 12px;
}

/* User Contact */
.user-contact {
    min-width: 150px;
}

.contact-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.contact-email {
    color: #e2e8f0;
    font-size: 12px;
    font-weight: 500;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.contact-phone {
    color: #9ca3af;
    font-size: 11px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

/* Role and Status Badges */
.role-badge, .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.role-superadmin {
    background: #fef3c7;
    color: #92400e;
}

.role-admin {
    background: #dbeafe;
    color: #1e40af;
}

.role-user {
    background: #dcfce7;
    color: #166534;
}

.role-manager {
    background: #fef3c7;
    color: #92400e;
}

.role-supervisor {
    background: #dbeafe;
    color: #1e40af;
}

.role-technician {
    background: #fce7f3;
    color: #be185d;
}

.role-analyst {
    background: #ecfdf5;
    color: #047857;
}

.status-active {
    background: #dcfce7;
    color: #166534;
}

.status-inactive {
    background: #fee2e2;
    color: #991b1b;
}

/* Permission Groups */
.permission-groups {
    min-width: 200px;
}

.permission-group {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
}

.group-title {
    font-size: 11px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.group-title i {
    color: #3b82f6;
}

.permission-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.permission-checkbox-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: #64748b;
    cursor: pointer;
}

.permission-checkbox-item input[type="checkbox"] {
    width: 12px;
    height: 12px;
    accent-color: #3b82f6;
}

/* User Actions */
.user-actions {
    display: flex;
    gap: 8px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1d4ed8, #1e40af);
    transform: translateY(-1px);
}

.btn-secondary {
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
    background: #e2e8f0;
    color: #374151;
}

.btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.btn-success:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-1px);
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
    transform: translateY(-1px);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 11px;
}

/* Selected User Permissions */
.selected-user-permissions {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    padding: 24px 30px;
    margin-bottom: 24px;
    border: 2px solid #f59e0b;
}

.selected-user-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f59e0b;
}

.selected-user-info {
    display: flex;
    gap: 12px;
}

.user-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.user-badge.role-superadmin {
    background: #fef3c7;
    color: #92400e;
}

.user-badge.role-admin {
    background: #dbeafe;
    color: #1e40af;
}

.user-badge.role-user {
    background: #dcfce7;
    color: #166534;
}

.user-badge.status-active {
    background: #dcfce7;
    color: #166534;
}

.user-badge.status-inactive {
    background: #fee2e2;
    color: #991b1b;
}

.selected-user-permissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.selected-user-actions {
    display: flex;
    gap: 16px;
    justify-content: center;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

/* Additional Permissions */
.additional-permissions {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    padding: 24px 30px;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-top: 20px;
}

.permission-category {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
}

.category-title {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.category-title i {
    color: #3b82f6;
}

.permission-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.permission-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: #374151;
    cursor: pointer;
}

.permission-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #3b82f6;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
}

.modal-overlay.hidden {
    display: none;
}

.modal-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
}

.permission-modal {
    max-width: 800px;
}

.user-details-modal {
    max-width: 700px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 30px;
    border-bottom: 1px solid #e2e8f0;
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-title i {
    color: #3b82f6;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #64748b;
    cursor: pointer;
    padding: 4px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    color: #ef4444;
    background: #fef2f2;
}

.modal-body {
    padding: 24px 30px;
}

/* Responsive */
@media (max-width: 1200px) {
    .permissions-container {
        padding: 16px;
    }
    
    .compact-header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .header-actions {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .users-table th,
    .users-table td {
        padding: 12px 16px;
    }
    
    .permission-groups {
        min-width: 150px;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .users-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .header-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .permissions-grid {
        grid-template-columns: 1fr;
    }
    
    .users-table-container {
        overflow-x: scroll;
    }
    
    .users-table {
        min-width: 800px;
    }
}
</style>

<!-- JavaScript -->
<script>
// Global variables
let currentEditingUser = null;
let permissionChanges = {};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializePermissionTracking();
    setupEventListeners();
    
    // Check if user_id is in URL and auto-select
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    if (userId) {
        // Find the user row and highlight it
        const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
        if (userRow) {
            userRow.style.background = '#fef3c7';
            userRow.style.border = '2px solid #f59e0b';
            
            // Scroll to the user row
            userRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Show notification
            setTimeout(() => {
                addNotification('info', 'Kullanıcı Seçildi', 
                    `Kullanıcı ID: ${userId} otomatik olarak seçildi. Yetkilerini düzenleyebilirsiniz.`, 
                    `<button class="notification-btn-small primary" onclick="editUserPermissions(${userId})">Yetkileri Düzenle</button>`, 
                    'user');
            }, 1000);
        }
    }
});

// Initialize permission tracking
function initializePermissionTracking() {
    // Track all checkbox changes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            trackPermissionChange(this);
        });
    });
}

// Setup event listeners
function setupEventListeners() {
    // Save all permissions button
    document.querySelector('.btn-success').addEventListener('click', saveAllPermissions);
    
    // Reset all permissions button
    document.querySelector('.btn-warning').addEventListener('click', resetAllPermissions);
}

// Track permission changes
function trackPermissionChange(checkbox) {
    const name = checkbox.name;
    const checked = checkbox.checked;
    
    if (!permissionChanges[name]) {
        permissionChanges[name] = {
            original: !checked,
            current: checked
        };
    } else {
        permissionChanges[name].current = checked;
    }
    
    // Visual feedback
    if (permissionChanges[name].original !== permissionChanges[name].current) {
        checkbox.closest('.permission-checkbox-item').style.background = '#fef3c7';
    } else {
        checkbox.closest('.permission-checkbox-item').style.background = 'transparent';
    }
}

// Save all permissions
function saveAllPermissions() {
    if (Object.keys(permissionChanges).length === 0) {
        addNotification('warning', 'Değişiklik Yok', 'Henüz bir değişiklik yapılmadı!', null, 'user');
        return;
    }
    
    if (!confirm('Tüm yetki değişikliklerini kaydetmek istediğinizden emin misiniz?')) {
        return;
    }
    
    // Collect all permission data
    const permissionsData = {};
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        permissionsData[checkbox.name] = checkbox.checked;
    });
    
    // Send to server (simulated)
    console.log('Saving permissions:', permissionsData);
    
    // Show success message
    addNotification('success', 'Yetkiler Kaydedildi', 'Tüm yetkiler başarıyla kaydedildi!', null, 'user');
    
    // Reset changes
    permissionChanges = {};
    document.querySelectorAll('.permission-checkbox-item').forEach(item => {
        item.style.background = 'transparent';
    });
}

// Reset all permissions
function resetAllPermissions() {
    if (!confirm('Tüm değişiklikleri sıfırlamak istediğinizden emin misiniz?')) {
        return;
    }
    
    // Reset to original state
    Object.keys(permissionChanges).forEach(name => {
        const checkbox = document.querySelector(`input[name="${name}"]`);
        if (checkbox) {
            checkbox.checked = permissionChanges[name].original;
            checkbox.closest('.permission-checkbox-item').style.background = 'transparent';
        }
    });
    
    permissionChanges = {};
}

// Save selected user permissions
function saveSelectedUserPermissions(userId) {
    if (!confirm(`${userId} ID'li kullanıcının yetkilerini kaydetmek istediğinizden emin misiniz?`)) {
        return;
    }
    
    // Collect permissions for this specific user
    const userPermissions = {};
    document.querySelectorAll(`input[name^="user_${userId}_"]`).forEach(checkbox => {
        userPermissions[checkbox.name] = checkbox.checked;
    });
    
    // Send to server (simulated)
    console.log('Saving permissions for user:', userId, userPermissions);
    
    // Show success message
    addNotification('success', 'Yetkiler Kaydedildi', 
        `${userId} ID'li kullanıcının yetkileri başarıyla kaydedildi!`, null, 'user');
    
    // Reset changes for this user
    Object.keys(permissionChanges).forEach(name => {
        if (name.startsWith(`user_${userId}_`)) {
            const checkbox = document.querySelector(`input[name="${name}"]`);
            if (checkbox) {
                checkbox.closest('.permission-checkbox-item').style.background = 'transparent';
            }
            delete permissionChanges[name];
        }
    });
}

// Reset selected user permissions
function resetSelectedUserPermissions(userId) {
    if (!confirm(`${userId} ID'li kullanıcının yetkilerini sıfırlamak istediğinizden emin misiniz?`)) {
        return;
    }
    
    // Reset to original state for this user
    Object.keys(permissionChanges).forEach(name => {
        if (name.startsWith(`user_${userId}_`)) {
            const checkbox = document.querySelector(`input[name="${name}"]`);
            if (checkbox) {
                checkbox.checked = permissionChanges[name].original;
                checkbox.closest('.permission-checkbox-item').style.background = 'transparent';
            }
        }
    });
    
    // Remove changes for this user
    Object.keys(permissionChanges).forEach(name => {
        if (name.startsWith(`user_${userId}_`)) {
            delete permissionChanges[name];
        }
    });
    
    addNotification('info', 'Yetkiler Sıfırlandı', 
        `${userId} ID'li kullanıcının yetkileri sıfırlandı.`, null, 'user');
}

// Edit user permissions
function editUserPermissions(userId) {
    currentEditingUser = userId;
    
    // Load user permissions into modal
    const modalContent = document.getElementById('permissionModalContent');
    modalContent.innerHTML = `
        <div class="user-permissions-form">
            <h4>Kullanıcı ID: ${userId}</h4>
            <p>Bu kullanıcının yetkilerini düzenleyin.</p>
            
            <div class="permissions-form">
                <div class="form-group">
                    <label>Kullanıcı Yetkileri</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="edit_user_${userId}_can_view_users"> Görüntüle</label>
                        <label><input type="checkbox" name="edit_user_${userId}_can_add_users"> Ekle</label>
                        <label><input type="checkbox" name="edit_user_${userId}_can_edit_users"> Düzenle</label>
                        <label><input type="checkbox" name="edit_user_${userId}_can_delete_users"> Sil</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Cihaz Yetkileri</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="edit_user_${userId}_can_view_devices"> Görüntüle</label>
                        <label><input type="checkbox" name="edit_user_${userId}_can_add_devices"> Ekle</label>
                        <label><input type="checkbox" name="edit_user_${userId}_can_edit_devices"> Düzenle</label>
                        <label><input type="checkbox" name="edit_user_${userId}_can_delete_devices"> Sil</label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="hidePermissionModal()" class="btn btn-secondary">İptal</button>
                    <button type="button" onclick="saveUserPermissions(${userId})" class="btn btn-success">Kaydet</button>
                </div>
            </div>
        </div>
    `;
    
    showPermissionModal();
}

// Show permission modal
function showPermissionModal() {
    document.getElementById('permissionModal').classList.remove('hidden');
}

// Hide permission modal
function hidePermissionModal() {
    document.getElementById('permissionModal').classList.add('hidden');
    currentEditingUser = null;
}

// Save user permissions
function saveUserPermissions(userId) {
    // Collect form data and save
    console.log('Saving permissions for user:', userId);
    alert('Kullanıcı yetkileri kaydedildi!');
    hidePermissionModal();
}

// View user details
function viewUserDetails(userId) {
    const modalContent = document.getElementById('userDetailsContent');
    modalContent.innerHTML = `
        <div class="user-details">
            <h4>Kullanıcı ID: ${userId}</h4>
            <p>Bu kullanıcının detaylı bilgileri burada görüntülenecek.</p>
            
            <div class="user-info-grid">
                <div class="info-item">
                    <span class="label">Kullanıcı Adı:</span>
                    <span class="value">user_${userId}</span>
                </div>
                <div class="info-item">
                    <span class="label">E-posta:</span>
                    <span class="value">user${userId}@example.com</span>
                </div>
                <div class="info-item">
                    <span class="label">Rol:</span>
                    <span class="value">Kullanıcı</span>
                </div>
                <div class="info-item">
                    <span class="label">Durum:</span>
                    <span class="value">Aktif</span>
                </div>
            </div>
        </div>
    `;
    
    showUserDetailsModal();
}

// Show user details modal
function showUserDetailsModal() {
    document.getElementById('userDetailsModal').classList.remove('hidden');
}

// Hide user details modal
function hideUserDetailsModal() {
    document.getElementById('userDetailsModal').classList.add('hidden');
}

// Close modals when clicking outside
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.classList.add('hidden');
        });
    }
});

// Bulk role update function
function bulkRoleUpdate() {
    const roles = ['user', 'admin', 'superadmin', 'manager', 'supervisor', 'technician', 'analyst'];
    const selectedRole = prompt('Hangi role güncellemek istiyorsunuz?\n\nMevcut roller:\n' + roles.map(r => `- ${r}`).join('\n'));
    
    if (selectedRole && roles.includes(selectedRole)) {
        if (confirm(`Seçili tüm kullanıcıları "${selectedRole}" rolüne güncellemek istediğinizden emin misiniz?`)) {
            addNotification('success', 'Toplu Güncelleme', `Kullanıcılar başarıyla ${selectedRole} rolüne güncellendi!`, null, 'user');
            console.log('Bulk role update:', selectedRole);
        }
    } else if (selectedRole) {
        addNotification('error', 'Geçersiz Rol', 'Lütfen geçerli bir rol seçin!', null, 'user');
    }
}

// Export permissions function
function exportPermissions() {
    const format = confirm('PDF formatında dışa aktarmak istiyor musunuz?\n\nOK = PDF\nCancel = Excel');
    const formatType = format ? 'PDF' : 'Excel';
    
    addNotification('success', 'Dışa Aktarma', `${formatType} formatında yetkiler dışa aktarılıyor...`, null, 'user');
    console.log('Exporting permissions as:', formatType);
    
    // Simulate export
    setTimeout(() => {
        addNotification('success', 'Dışa Aktarma Tamamlandı', `${formatType} dosyası başarıyla oluşturuldu!`, null, 'user');
    }, 2000);
}

// Add notification function (if not exists)
function addNotification(type, title, message, action, icon) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'}, ${type === 'success' ? '#059669' : type === 'warning' ? '#d97706' : type === 'error' ? '#dc2626' : '#2563eb'});
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        max-width: 350px;
        animation: slideInRight 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times-circle' : 'info-circle'}" style="font-size: 20px;"></i>
            <div>
                <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; opacity: 0.9;">${message}</div>
                ${action ? `<div style="margin-top: 8px;">${action}</div>` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 5 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 5000);
}

// Add keyframe animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
