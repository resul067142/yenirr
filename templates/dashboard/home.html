{% extends 'layout/base.html' %}

{% block title %}Dashboard - Cihaz Takip Sistemi{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="cyber-card">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Hoş Geldiniz, {{ user.get_full_name }}!</h1>
                <p class="text-cyan-400 text-lg">Siber güvenlik cihaz takip sisteminize hoş geldiniz</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-400">{{ user.get_role_display }}</p>
                <p class="text-xs text-cyan-400 font-mono">Son giriş: {{ user.last_login|date:"d.m.Y H:i" }}</p>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Toplam Cihaz -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl flex items-center justify-center cyber-glow">
                        <i class="fas fa-mobile-alt text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Toplam Cihaz</p>
                    <p class="text-3xl font-bold text-white">{{ total_devices }}</p>
                </div>
            </div>
        </div>

        <!-- Aktif Cihaz -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-xl flex items-center justify-center cyber-glow">
                        <i class="fas fa-check-circle text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Aktif Cihaz</p>
                    <p class="text-3xl font-bold text-white">{{ active_devices }}</p>
                </div>
            </div>
        </div>

        <!-- Pasif Cihaz -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center cyber-glow">
                        <i class="fas fa-pause-circle text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Pasif Cihaz</p>
                    <p class="text-3xl font-bold text-white">{{ inactive_devices }}</p>
                </div>
            </div>
        </div>

        {% if is_admin %}
        <!-- Kullanıcı Başına Ortalama -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl flex items-center justify-center cyber-glow">
                        <i class="fas fa-users text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Ortalama/Cihaz</p>
                    <p class="text-3xl font-bold text-white">{{ avg_devices_per_user }}</p>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Cihaz Ekleme Butonu -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="flex items-center justify-center h-full">
                <a href="{% url 'devices:device_add' %}" class="btn-cyber-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Cihaz Ekle
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    {% if is_admin %}
    <!-- Admin Statistics Row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Toplam Kullanıcı -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center cyber-glow">
                        <i class="fas fa-user-friends text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Toplam Kullanıcı</p>
                    <p class="text-3xl font-bold text-white">{{ total_users }}</p>
                </div>
            </div>
        </div>

        <!-- Kilitli Hesaplar -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-xl flex items-center justify-center cyber-glow">
                        <i class="fas fa-lock text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Kilitli Hesaplar</p>
                    <p class="text-3xl font-bold text-white">{{ locked_accounts }}</p>
                </div>
            </div>
        </div>

        <!-- Hızlı İşlemler -->
        <div class="cyber-card stat-card hover:scale-105 transition-transform duration-300">
            <div class="space-y-3">
                <p class="text-sm font-medium text-gray-400">Hızlı İşlemler</p>
                <div class="flex space-x-2">
                    <a href="{% url 'devices:device_add' %}" class="btn-cyber-primary text-xs py-2 px-3">
                        <i class="fas fa-plus mr-1"></i>
                        Cihaz Ekle
                    </a>
                    <a href="{% url 'users:user_list' %}" class="btn-cyber-secondary text-xs py-2 px-3">
                        <i class="fas fa-users mr-1"></i>
                        Kullanıcılar
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Son 7 Günlük Cihaz Kayıtları -->
        <div class="cyber-card">
            <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2"></i>
                Son 7 Günlük Cihaz Kayıtları
            </h3>
            <div class="chart-container">
                <canvas id="deviceChart"></canvas>
            </div>
        </div>

        <!-- Cihaz Türü Dağılımı -->
        <div class="cyber-card">
            <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center">
                <i class="fas fa-chart-pie mr-2"></i>
                Cihaz Türü Dağılımı
            </h3>
            <div class="chart-container">
                <canvas id="deviceTypeChart"></canvas>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- Additional Admin Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Son 7 Günlük Kullanıcı Kayıtları -->
        <div class="cyber-card">
            <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center">
                <i class="fas fa-chart-area mr-2"></i>
                Son 7 Günlük Kullanıcı Kayıtları
            </h3>
            <div class="chart-container">
                <canvas id="userChart"></canvas>
            </div>
        </div>

        <!-- Kullanıcı Rolü Dağılımı -->
        <div class="cyber-card">
            <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center">
                <i class="fas fa-users-cog mr-2"></i>
                Kullanıcı Rolü Dağılımı
            </h3>
            <div class="chart-container">
                <canvas id="userRoleChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Activities -->
    <div class="cyber-card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-cyan-400 flex items-center">
                <i class="fas fa-history mr-2"></i>
                Son Aktiviteler
            </h3>
            <a href="{% url 'dashboard:activity_log' %}" class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors">
                Tümünü Gör <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        <div class="space-y-3">
            {% for activity in recent_activities %}
            <div class="flex items-center p-4 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700 transition-colors">
                <div class="flex-shrink-0">
                    {% if activity.log_type == 'login' %}
                        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center cyber-glow">
                            <i class="fas fa-sign-in-alt text-white text-sm"></i>
                        </div>
                    {% elif activity.log_type == 'device_add' %}
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center cyber-glow">
                            <i class="fas fa-plus text-white text-sm"></i>
                        </div>
                    {% elif activity.log_type == 'device_update' %}
                        <div class="w-10 h-10 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-full flex items-center justify-center cyber-glow">
                            <i class="fas fa-edit text-white text-sm"></i>
                        </div>
                    {% else %}
                        <div class="w-10 h-10 bg-gradient-to-r from-gray-500 to-gray-600 rounded-full flex items-center justify-center cyber-glow">
                            <i class="fas fa-info text-white text-sm"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-bold text-white">
                        {% if is_admin %}
                            {{ activity.user.get_full_name }}
                        {% else %}
                            Siz
                        {% endif %}
                    </p>
                    <p class="text-sm text-gray-400">{{ activity.description }}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-cyan-400 font-mono">{{ activity.created_at|date:"d.m.Y H:i" }}</p>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-8 text-gray-400">
                <i class="fas fa-info-circle text-4xl mb-3"></i>
                <p>Henüz aktivite bulunmuyor.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Chart.js Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Son 7 Günlük Cihaz Kayıtları Grafiği
    const deviceCtx = document.getElementById('deviceChart').getContext('2d');
    const deviceChart = new Chart(deviceCtx, {
        type: 'line',
        data: {
            labels: [{% for day in last_7_days_devices %}'{{ day.date }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Yeni Cihazlar',
                data: [{% for day in last_7_days_devices %}{{ day.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                borderColor: '#00ffff',
                backgroundColor: 'rgba(0, 255, 255, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#6B7280'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.2)'
                    }
                },
                x: {
                    ticks: {
                        color: '#6B7280'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.2)'
                    }
                }
            }
        }
    });

    // Cihaz Türü Dağılımı Grafiği
    const deviceTypeCtx = document.getElementById('deviceTypeChart').getContext('2d');
    const deviceTypeChart = new Chart(deviceTypeCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for type, count in device_type_stats.items %}'{{ type }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for type, count in device_type_stats.items %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [
                    '#00ffff',
                    '#10b981',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6'
                ],
                borderWidth: 2,
                borderColor: '#1f2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#6B7280',
                        padding: 20
                    }
                }
            }
        }
    });

    {% if is_admin %}
    // Son 7 Günlük Kullanıcı Kayıtları Grafiği
    const userCtx = document.getElementById('userChart').getContext('2d');
    const userChart = new Chart(userCtx, {
        type: 'line',
        data: {
            labels: [{% for day in last_7_days_users %}'{{ day.date }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Yeni Kullanıcılar',
                data: [{% for day in last_7_days_users %}{{ day.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#6B7280'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.2)'
                    }
                },
                x: {
                    ticks: {
                        color: '#6B7280'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.2)'
                    }
                }
            }
        }
    });

    // Kullanıcı Rolü Dağılımı Grafiği
    const userRoleCtx = document.getElementById('userRoleChart').getContext('2d');
    const userRoleChart = new Chart(userRoleCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for role, count in user_role_stats.items %}'{{ role }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for role, count in user_role_stats.items %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [
                    '#00ffff',
                    '#10b981',
                    '#f59e0b'
                ],
                borderWidth: 2,
                borderColor: '#1f2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#6B7280',
                        padding: 20
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
